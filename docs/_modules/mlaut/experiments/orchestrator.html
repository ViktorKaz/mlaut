

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mlaut.experiments.orchestrator &mdash; mlaut 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> mlaut
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../project.html">Description of the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mlaut</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mlaut.experiments.orchestrator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mlaut.experiments.orchestrator</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">mlaut.shared.static_variables</span> <span class="k">import</span> <span class="p">(</span><span class="n">X_TRAIN_DIR</span><span class="p">,</span> 
                                       <span class="n">X_TEST_DIR</span><span class="p">,</span> 
                                       <span class="n">Y_TRAIN_DIR</span><span class="p">,</span> 
                                       <span class="n">Y_TEST_DIR</span><span class="p">,</span> 
                                       <span class="n">TRAIN_IDX</span><span class="p">,</span> 
                                       <span class="n">TEST_IDX</span><span class="p">,</span> 
                                       <span class="n">EXPERIMENTS_PREDICTIONS_GROUP</span><span class="p">,</span>
                                       <span class="n">SPLIT_DTS_GROUP</span><span class="p">,</span>
                                       <span class="n">EXPERIMENTS_TRAINED_MODELS_DIR</span><span class="p">,</span> 
                                       <span class="n">LOG_ERROR_FILE</span><span class="p">,</span> <span class="n">set_logging_defaults</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">mlaut.shared.files_io</span> <span class="k">import</span> <span class="n">FilesIO</span>
<span class="c1">#from mlaut.experiments.experiments import Experiments</span>
<span class="kn">from</span> <span class="nn">mlaut.data</span> <span class="k">import</span> <span class="n">Data</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">mlaut.shared.files_io</span> <span class="k">import</span> <span class="n">DiskOperations</span>

<div class="viewcode-block" id="Orchestrator"><a class="viewcode-back" href="../../../experiments.html#mlaut.experiments.orchestrator.Orchestrator">[docs]</a><span class="k">class</span> <span class="nc">Orchestrator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates the sequencing of running the machine learning experiments.</span>

<span class="sd">    Args:</span>
<span class="sd">        hdf5_input_io (:func:`~mlaut.shared.files_io.FilesIO`): instance of :func:`~mlaut.shared.files_io.FilesIO` with reference to the input file.</span>
<span class="sd">        hdf5_output_io (:func:`~mlaut.shared.files_io.FilesIO`): instance of :func:`~mlaut.shared.files_io.FilesIO` with reference to the output file.</span>
<span class="sd">        dts_names (array of strings): array with the names of the datasets on which experiments will be run.</span>
<span class="sd">        original_datasets_group_h5_path (sting): root path where the raw datasets are stored</span>
<span class="sd">        experiments_predictions_group (string): path in HDF5 database where predictions will be saved.</span>
<span class="sd">        experiments_trained_models_dir (string): folder on disk where trained estimators will be saved.</span>
<span class="sd">        split_datasets_group (string): path in HDF5 database where the splits are saved.</span>
<span class="sd">        train_idx (string): folder in HDF5 database which holds the train index splits.</span>
<span class="sd">        test_idx (string): folder in HDF5 database which holds the test index splits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">hdf5_input_io</span><span class="p">,</span> 
                 <span class="n">hdf5_output_io</span><span class="p">,</span>
                 <span class="n">dts_names</span><span class="p">,</span>
                 <span class="n">original_datasets_group_h5_path</span><span class="p">,</span> 
                 <span class="n">experiments_predictions_group</span><span class="o">=</span><span class="n">EXPERIMENTS_PREDICTIONS_GROUP</span><span class="p">,</span>
                 <span class="n">experiments_trained_models_dir</span><span class="o">=</span><span class="n">EXPERIMENTS_TRAINED_MODELS_DIR</span><span class="p">,</span>
                 <span class="n">split_datasets_group</span><span class="o">=</span><span class="n">SPLIT_DTS_GROUP</span><span class="p">,</span>
                 <span class="n">train_idx</span><span class="o">=</span><span class="n">TRAIN_IDX</span><span class="p">,</span>
                 <span class="n">test_idx</span><span class="o">=</span><span class="n">TEST_IDX</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dts_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dts_names must be an array&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiments_predictions_group</span><span class="o">=</span><span class="n">experiments_predictions_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_experiments_trained_models_dir</span><span class="o">=</span><span class="n">experiments_trained_models_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_io</span> <span class="o">=</span> <span class="n">hdf5_input_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span> <span class="o">=</span> <span class="n">hdf5_output_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dts_names</span><span class="o">=</span><span class="n">dts_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_datasets_group_h5_path</span> <span class="o">=</span> <span class="n">original_datasets_group_h5_path</span>
        <span class="c1">#self._experiments = Experiments(self._experiments_trained_models_dir)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disk_op</span> <span class="o">=</span> <span class="n">DiskOperations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">experiments_predictions_group</span><span class="p">,</span> 
                          <span class="n">split_datasets_group</span><span class="p">,</span>
                          <span class="n">train_idx</span><span class="p">,</span>
                          <span class="n">test_idx</span><span class="p">)</span> 
        <span class="n">set_logging_defaults</span><span class="p">()</span>

<div class="viewcode-block" id="Orchestrator.run"><a class="viewcode-back" href="../../../experiments.html#mlaut.experiments.orchestrator.Orchestrator.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">modelling_strategies</span><span class="p">,</span> 
            <span class="n">overwrite_saved_models</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">predict_on_runtime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">overwrite_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">overwrite_timestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Main module for training the estimators. </span>
<span class="sd">        The inputs of the function are: </span>

<span class="sd">        1. The input and output databse files containing the datasets.</span>

<span class="sd">        2. The instantiated estimators.</span>
<span class="sd">        </span>
<span class="sd">        The method iterates through all datasets in the input database file </span>
<span class="sd">        and trains all modelling strategies on these datasets. At the end of the process </span>
<span class="sd">        we make predictions on the test sets and store them in the output database file.</span>

<span class="sd">        The class uses helper methods in the experiments class to avoid too many nested loops.</span>

<span class="sd">        Args:</span>
<span class="sd">            odelling_strategies (array of :ref:`mlaut_estimator-label` objects): Array of estimators that will be used for training</span>
<span class="sd">            overwrite_saved_models (Boolean): Flag whether the trained models should be overwritten if they already exist on the disk.</span>
<span class="sd">            verbose (Boolean): If True prints info and warning messages.</span>
<span class="sd">            predict_on_runtime(Boolean): Make predictions immediately after the estimators are trained.</span>
<span class="sd">            overwrite_predictions(Boolean): Overwrite predictions in database if they exist already.</span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#loop through all datasets</span>
            <span class="n">dts_trained</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">dts_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dts_names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prediction_accuracies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">dts_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dts_names</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;Training estimators on </span><span class="si">{dts_name}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">dts_trained</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">load_test_train_dts</span><span class="p">(</span><span class="n">hdf5_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="p">,</span> 
                                                                              <span class="n">hdf5_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_io</span><span class="p">,</span> 
                                                                              <span class="n">dts_name</span><span class="o">=</span><span class="n">dts_name</span><span class="p">,</span> 
                                                                              <span class="n">dts_grp_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_datasets_group_h5_path</span><span class="p">)</span>

                <span class="n">timestamps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">modelling_strategy</span> <span class="ow">in</span> <span class="n">modelling_strategies</span><span class="p">:</span>
                    <span class="n">ml_strategy_name</span> <span class="o">=</span> <span class="n">modelling_strategy</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">begin_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                    <span class="c1">#check whether the model was already trained</span>
                    <span class="n">path_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiments_trained_models_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">dts_name</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">ml_strategy_name</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span>
                    <span class="n">model_exists</span><span class="p">,</span> <span class="n">path_to_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disk_op</span><span class="o">.</span><span class="n">check_path_exists</span><span class="p">(</span><span class="n">path_to_check</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model_exists</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">overwrite_saved_models</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        
                        <span class="c1"># modelling_strategy.load(path_to_model)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Estimator </span><span class="si">{ml_strategy_name}</span><span class="s1"> already trained on </span><span class="si">{dts_name}</span><span class="s1">. Skipping it.&#39;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span> <span class="c1">#modelling strategy does not exist</span>
           
                        <span class="n">num_samples</span><span class="p">,</span> <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
                        <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> 
                        <span class="n">built_model</span> <span class="o">=</span> <span class="n">modelling_strategy</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span> 
                                                                <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span>
                                                                <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;** Training estimator: </span><span class="si">{ml_strategy_name}</span><span class="s1"> on dataset: </span><span class="si">{dts_name}</span><span class="s1">. Datasets processed: </span><span class="si">{dts_trained}</span><span class="s1">/</span><span class="si">{dts_total}</span><span class="s1"> **&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">trained_model</span> <span class="o">=</span> <span class="n">built_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                            <span class="n">timestamps_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_timestamp</span><span class="p">(</span><span class="n">ml_strategy_name</span><span class="p">,</span> <span class="n">begin_timestamp</span><span class="p">,</span> <span class="n">timestamps_df</span><span class="p">)</span>
                            <span class="n">modelling_strategy</span><span class="o">.</span><span class="n">set_trained_model</span><span class="p">(</span><span class="n">trained_model</span><span class="p">)</span>
                            <span class="n">modelling_strategy</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dts_name</span><span class="p">)</span>
                        
                            <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="o">.</span><span class="n">save_ml_strategy_timestamps</span><span class="p">(</span><span class="n">timestamps_df</span><span class="p">,</span> <span class="n">dts_name</span><span class="p">,</span> <span class="n">overwrite_timestamp</span><span class="o">=</span><span class="n">overwrite_timestamp</span><span class="p">)</span>
                        
                            <span class="c1">#make predictions</span>
                            <span class="k">if</span> <span class="n">predict_on_runtime</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">modelling_strategy</span><span class="p">,</span> 
                                        <span class="n">X_test</span><span class="p">,</span> 
                                        <span class="n">dataset_name</span><span class="o">=</span><span class="n">dts_name</span><span class="p">,</span> 
                                        <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite_predictions</span><span class="p">,</span> 
                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                        
                            <span class="n">trained_model</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">modelling_strategy</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">built_model</span> <span class="o">=</span> <span class="kc">None</span>
                        
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Failed to train dataset </span><span class="si">{ml_strategy_name}</span><span class="s1"> on dataset: </span><span class="si">{dts_name}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Failed to train dataset </span><span class="si">{ml_strategy_name}</span><span class="s1"> on dataset: </span><span class="si">{dts_name}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;*****Stack trace: </span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                   



        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="c1"># quit</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***************************&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;********  EXITING  ********&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;***************************&#39;</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_record_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">begin_timestamp</span><span class="p">,</span> <span class="n">timestamps_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Timestamp used to record the duration of training for each of the estimators&quot;&quot;&quot;</span>
        <span class="n">STF</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>
        <span class="n">end_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_timestamp</span> <span class="o">-</span> <span class="n">begin_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> 
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategy_name</span><span class="p">,</span> <span class="n">begin_timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">STF</span><span class="p">),</span><span class="n">end_timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">STF</span><span class="p">),</span><span class="n">diff</span><span class="p">]</span>
        <span class="n">run_time_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">vals</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;strategy_name&#39;</span><span class="p">,</span><span class="s1">&#39;begin_time&#39;</span><span class="p">,</span><span class="s1">&#39;end_time&#39;</span><span class="p">,</span><span class="s1">&#39;total_seconds&#39;</span><span class="p">])</span>
        <span class="n">timestamps_df</span> <span class="o">=</span> <span class="n">timestamps_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_time_df</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">timestamps_df</span>

    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelling_strategy</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make predictions on test sets. The algorithm opens all saved estimators in the output directory and checks whether their names are specified in the estimators array. If they are it fetches the dataset splits and tries to make the predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            modelling_strategy (:ref:`mlaut_estimator-label` object): The trained estimator object.</span>
<span class="sd">            X_test(numpy array): Test dataset.</span>
<span class="sd">            dataset_name(string): name of the dataset on which the estimator was trained.</span>
<span class="sd">            overwrite (Boolean): If True overwrites predictions in HDF5 database.</span>
<span class="sd">            verbose (Boolean): If True prints info and warning messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trained_estimator</span> <span class="o">=</span> <span class="n">modelling_strategy</span><span class="o">.</span><span class="n">get_trained_model</span><span class="p">()</span>
        <span class="n">name_estimator</span> <span class="o">=</span> <span class="n">modelling_strategy</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="o">.</span><span class="n">save_prediction_to_db</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> 
                                                        <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span> 
                                                        <span class="n">strategy_name</span><span class="o">=</span><span class="n">name_estimator</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Predictions for </span><span class="si">{name_estimator}</span><span class="s1"> on </span><span class="si">{dataset_name}</span><span class="s1"> Saved in database.&#39;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#check whether the prediction exists before proceeding</span>
            <span class="n">path_h5_predictions</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self._experiments_predictions_group}</span><span class="s1">/</span><span class="si">{dataset_name}</span><span class="s1">/</span><span class="si">{name_estimator}</span><span class="s1">&#39;</span>
            <span class="n">predictions_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="o">.</span><span class="n">check_h5_path_exists</span><span class="p">(</span><span class="n">path_h5_predictions</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">predictions_exist</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Predictions for </span><span class="si">{name_estimator}</span><span class="s1"> on </span><span class="si">{dataset_name}</span><span class="s1"> already exist in the database. Set overwrite to True if you wish replace them.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="o">.</span><span class="n">save_prediction_to_db</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> 
                                                      <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span> 
                                                      <span class="n">strategy_name</span><span class="o">=</span><span class="n">name_estimator</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Predictions for </span><span class="si">{name_estimator}</span><span class="s1"> on </span><span class="si">{dataset_name}</span><span class="s1"> saved in database.&#39;</span><span class="p">)</span>
        
        <span class="n">trained_estimator</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Orchestrator.predict_all"><a class="viewcode-back" href="../../../experiments.html#mlaut.experiments.orchestrator.Orchestrator.predict_all">[docs]</a>    <span class="k">def</span> <span class="nf">predict_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trained_models_dir</span><span class="p">,</span> <span class="n">estimators</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make predictions on test sets. The algorithm opens all saved estimators in the output directory and checks whether their names are specified in the estimators array. If they are it fetches the dataset splits and tries to make the predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            trained_models_dir (string): directory where the trained models are saved.</span>
<span class="sd">            estimators (array of :ref:`mlaut_estimator-label` objects): The trained models are set as a property to the object.</span>
<span class="sd">            overwrite (Boolean): If True overwrites predictions in HDF5 database.</span>
<span class="sd">            verbose (Boolean): If True prints info and warning messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">trained_models_dir</span><span class="p">)</span>
        <span class="n">names_all_estimators</span> <span class="o">=</span> <span class="p">[</span><span class="n">estimator</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="n">estimators</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dts_names</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">load_test_train_dts</span><span class="p">(</span><span class="n">hdf5_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="p">,</span> 
                                                                              <span class="n">hdf5_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_io</span><span class="p">,</span> 
                                                                              <span class="n">dts_name</span><span class="o">=</span><span class="n">dts</span><span class="p">,</span> 
                                                                              <span class="n">dts_grp_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_datasets_group_h5_path</span><span class="p">)</span>
            <span class="n">saved_estimators</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{trained_models_dir}</span><span class="s1">/</span><span class="si">{dts}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">saved_estimator</span> <span class="ow">in</span> <span class="n">saved_estimators</span><span class="p">:</span>
                <span class="n">name_estimator</span> <span class="o">=</span> <span class="n">saved_estimator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># try:</span>
                <span class="k">if</span> <span class="n">name_estimator</span> <span class="ow">in</span> <span class="n">names_all_estimators</span><span class="p">:</span>
                    <span class="c1">#check whether predictions exist in the database before continuing</span>
                    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">path_h5_predictions</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self._experiments_predictions_group}</span><span class="s1">/</span><span class="si">{dts}</span><span class="s1">/</span><span class="si">{name_estimator}</span><span class="s1">&#39;</span>
                        <span class="n">predictions_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="o">.</span><span class="n">check_h5_path_exists</span><span class="p">(</span><span class="n">path_h5_predictions</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">predictions_exist</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Predictions for </span><span class="si">{name_estimator}</span><span class="s1"> on </span><span class="si">{dts}</span><span class="s1"> already exist in the database. Set overwrite to True if you wish replace them.&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                    
                    <span class="c1">#if overwrite is set to True make the predictions without checking</span>
                    <span class="n">idx_estimator</span> <span class="o">=</span> <span class="n">names_all_estimators</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name_estimator</span><span class="p">)</span>
                    <span class="n">estimator</span> <span class="o">=</span> <span class="n">estimators</span><span class="p">[</span><span class="n">idx_estimator</span><span class="p">]</span>

                    <span class="n">estimator</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{trained_models_dir}</span><span class="s1">/</span><span class="si">{dts}</span><span class="s1">/</span><span class="si">{saved_estimator}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">trained_estimator</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">get_trained_model</span><span class="p">()</span>
                    <span class="n">predictions</span> <span class="o">=</span> <span class="n">trained_estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_output_io</span><span class="o">.</span><span class="n">save_prediction_to_db</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> 
                                                        <span class="n">dataset_name</span><span class="o">=</span><span class="n">dts</span><span class="p">,</span> 
                                                        <span class="n">strategy_name</span><span class="o">=</span><span class="n">name_estimator</span><span class="p">)</span></div></div>
                   
        
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Viktor Kazakov

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>